<html><head><title>scalismo: Rigid alignment</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="University of Basel" /><meta name="description" content="Scalismo - Scalable Image Analysis and Shape Modelling " /><meta name="og:image" content="/scalismo.github.io/img/poster.png" /><meta name="image" property="og:image" content="/scalismo.github.io/img/poster.png" /><meta name="og:title" content="scalismo: Rigid alignment" /><meta name="title" property="og:title" content="scalismo: Rigid alignment" /><meta name="og:site_name" content="scalismo" /><meta name="og:url" content="" /><meta name="og:type" content="website" /><meta name="og:description" content="Scalismo - Scalable Image Analysis and Shape Modelling " /><link rel="icon" type="image/png" href="/scalismo.github.io/img/favicon.png" /><meta name="twitter:title" content="scalismo: Rigid alignment" /><meta name="twitter:image" content="/scalismo.github.io/img/poster.png" /><meta name="twitter:description" content="Scalismo - Scalable Image Analysis and Shape Modelling " /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/scalismo.github.io/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/scalismo.github.io/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/scalismo.github.io/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/scalismo.github.io/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/scalismo.github.io/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/scalismo.github.io/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/scalismo.github.io/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/scalismo.github.io/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/scalismo.github.io/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/scalismo.github.io/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/scalismo.github.io/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/scalismo.github.io/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/scalismo.github.io/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/scalismo.github.io/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/scalismo.github.io/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/scalismo.github.io/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/scalismo.github.io/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/scalismo.github.io/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/scalismo.github.io/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/scalismo.github.io/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/scalismo.github.io/highlight/styles/default.css" /><link rel="stylesheet" href="/scalismo.github.io/css/style.css" /><link rel="stylesheet" href="/scalismo.github.io/css/palette.css" /><link rel="stylesheet" href="/scalismo.github.io/css/codemirror.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/scalismo.github.io/" class="brand"><div class="brand-wrapper"><span>scalismo</span></div></a></li> <li><a href="/scalismo.github.io/tutorials/tutorial1.html" class="">Hello Scalismo</a></li> <li><a href="/scalismo.github.io/tutorials/tutorial2.html" class=" active ">Rigid alignment</a></li> <li><a href="/scalismo.github.io/tutorials/tutorial3.html" class="">From meshes to deformation fields</a></li> <li><a href="/scalismo.github.io/tutorials/tutorial4.html" class="">Gaussian processes and Point Distribution Models</a></li> <li><a href="/scalismo.github.io/tutorials/tutorial5.html" class="">Gaussian processes, sampling and marginalization</a></li> <li><a href="/scalismo.github.io/tutorials/tutorial6.html" class="">Building a shape model from data</a></li> <li><a href="/scalismo.github.io/tutorials/tutorial7.html" class="">Gaussian processes and kernels</a></li> <li><a href="/scalismo.github.io/tutorials/tutorial8.html" class="">Posterior Shape Models</a></li> <li><a href="/scalismo.github.io/tutorials/tutorial9.html" class="">Shape completion</a></li> <li><a href="/scalismo.github.io/tutorials/tutorial10.html" class="">ICP for rigid alignment</a></li> <li><a href="/scalismo.github.io/tutorials/tutorial11.html" class="">Model fitting with ICP</a></li> <li><a href="/scalismo.github.io/tutorials/tutorial12.html" class="">Parametric, non-rigid registration</a></li> <li><a href="/scalismo.github.io/tutorials/tutorial13.html" class="">Active Shape Models</a></li> <li><a href="/scalismo.github.io/tutorials/tutorial14.html" class="">Model fitting using MCMC - The basic framework</a></li> <li><a href="/scalismo.github.io/tutorials/tutorial14.html" class="">Model fitting using MCMC - Fitting a shape model</a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/marcelluethi/scalismo.github.io"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/marcelluethi/scalismo.github.io"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('scalismo Scalismo - Scalable Image Analysis and Shape Modelling ');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('scalismo Scalismo - Scalable Image Analysis and Shape Modelling ');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="marcelluethi" data-github-repo="scalismo.github.io"><div class="content-wrapper"><section><head>

    <script type="text/x-mathjax-config">
          MathJax.Hub.Config({
            tex2jax: {
              inlineMath: [ ['$','$'], ["\\(","\\)"] ],
              processEscapes: true
            }
          });
        </script>
    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
</head>

<h1 id="active-shape-model-fitting">Active Shape Model fitting</h1>

<p>In this tutorial we show how we can perform active shape model fitting in Scalismo.</p>

<h5 id="related-resources">Related resources</h5>

<p>The following resources from our <a href="https://www.futurelearn.com/courses/statistical-shape-modelling">online course</a> may provide
some helpful context for this tutorial:</p>

<ul>
  <li>Fitting models to images <a href="https://www.futurelearn.com/courses/statistical-shape-modelling/3/steps/250379">(Video)</a></li>
</ul>

<h5 id="preparation">Preparation</h5>

<p>As in the previous tutorials, we start by importing some commonly used objects and initializing the system.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">import</span> <span class="nn">scalismo.geometry._</span>
  <span class="k">import</span> <span class="nn">scalismo.ui.api._</span>
  <span class="k">import</span> <span class="nn">scalismo.registration._</span>
  <span class="k">import</span> <span class="nn">scalismo.mesh.TriangleMesh</span>
  <span class="k">import</span> <span class="nn">scalismo.statisticalmodel.asm._</span>
  <span class="k">import</span> <span class="nn">scalismo.io.</span><span class="o">{</span><span class="nc">ActiveShapeModelIO</span><span class="o">,</span> <span class="nc">ImageIO</span><span class="o">}</span>
  <span class="k">import</span> <span class="nn">breeze.linalg.</span><span class="o">{</span><span class="nc">DenseVector</span><span class="o">}</span>


<span class="n">scalismo</span><span class="o">.</span><span class="n">initialize</span><span class="o">()</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="n">rng</span> <span class="k">=</span> <span class="n">scalismo</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="nc">Random</span><span class="o">(</span><span class="mi">42</span><span class="o">)</span>

<span class="k">val</span> <span class="n">ui</span> <span class="k">=</span> <span class="nc">ScalismoUI</span><span class="o">()</span>
</code></pre></div></div>

<h2 id="active-shape-models-in-scalismo">Active Shape models in Scalismo</h2>

<p>Scalismo provides full support for Active Shape models. This means we can use it to learn active shape models from
a set of images and corresponding contour, we can save these models, and we can use them to fit images. In this tutorial
we will assume that the model has already been built and will only concentrate on model fitting.</p>

<p>We can load an Active Shape Model as follows:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="n">asm</span> <span class="k">=</span> <span class="nc">ActiveShapeModelIO</span><span class="o">.</span><span class="n">readActiveShapeModel</span><span class="o">(</span><span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="nc">File</span><span class="o">(</span><span class="s">"datasets/femur-asm.h5"</span><span class="o">)).</span><span class="n">get</span>
</code></pre></div></div>

<p>An ActiveShapeModel instance in Scalismo is a combination of a statistical shape model and an intensity model.
Using the method <code class="highlighter-rouge">statisticalModel</code>, we can obtain the shape model part. Let’s visualize this model:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="n">modelGroup</span> <span class="k">=</span> <span class="n">ui</span><span class="o">.</span><span class="n">createGroup</span><span class="o">(</span><span class="s">"modelGroup"</span><span class="o">)</span> 
<span class="k">val</span> <span class="n">modelView</span> <span class="k">=</span> <span class="n">ui</span><span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="n">modelGroup</span><span class="o">,</span> <span class="n">asm</span><span class="o">.</span><span class="n">statisticalModel</span><span class="o">,</span> <span class="s">"shapeModel"</span><span class="o">)</span>
</code></pre></div></div>

<p>The second part of the model is the intensity model. This model consists of a set of profiles,
which are attached to specific vertices of the shape model, indicated by the <code class="highlighter-rouge">pointId</code>.
For each profile, a probability distribution is defined. This distribution represent the intensity variation that we
expect for this profile.</p>

<p>The following code shows how this information can be accessed:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="n">profiles</span> <span class="k">=</span> <span class="n">asm</span><span class="o">.</span><span class="n">profiles</span>
<span class="n">profiles</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">profile</span> <span class="k">=&gt;</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">pointId</span> <span class="k">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">pointId</span>
    <span class="k">val</span> <span class="n">distribution</span> <span class="k">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">distribution</span>
<span class="o">})</span>
</code></pre></div></div>

<h4 id="finding-likely-model-correspondences-in-an-image">Finding likely model correspondences in an image</h4>

<p>The main usage of the profile distribution is to identify the points in the image, which are most likely to correspond to the given profile points in the model.
More precisely, let <script type="math/tex">p_i</script> denote the i-th profile in the model. We can use the information to evaluate for any set of points
$(x_1, \ldots, x_n)$, how likely it is that a point $x_j$ corresponds to the profile point $p_i$, based on the image intensity patterns
<script type="math/tex">\rho(x_1), \ldots, \rho(x_n)</script> we find at these points in an image.</p>

<p>To illustrate this, we first load an image:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="n">image</span> <span class="k">=</span> <span class="nc">ImageIO</span><span class="o">.</span><span class="n">read3DScalarImage</span><span class="o">[</span><span class="kt">Short</span><span class="o">](</span><span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="nc">File</span><span class="o">(</span><span class="s">"datasets/femur-image.nii"</span><span class="o">)).</span><span class="n">get</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toFloat</span><span class="o">)</span>
<span class="k">val</span> <span class="n">targetGroup</span> <span class="k">=</span> <span class="n">ui</span><span class="o">.</span><span class="n">createGroup</span><span class="o">(</span><span class="s">"target"</span><span class="o">)</span>

<span class="k">val</span> <span class="n">imageView</span> <span class="k">=</span> <span class="n">ui</span><span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="n">targetGroup</span><span class="o">,</span> <span class="n">image</span><span class="o">,</span> <span class="s">"image"</span><span class="o">)</span>
</code></pre></div></div>

<p>The ASM implementation in Scalismo, is not restricted to work with the raw intensities, but the active shape model may first apply some preprocessing,
such as smooth, applying a gradient transform, etc.  Thus in a first step we obtain this preprocess iamge uing the prepocessor method of the <code class="highlighter-rouge">asm</code> object:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="n">preprocessedImage</span> <span class="k">=</span> <span class="n">asm</span><span class="o">.</span><span class="n">preprocessor</span><span class="o">(</span><span class="n">image</span><span class="o">)</span>
</code></pre></div></div>

<p>We can now extract features at a given point:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="n">point1</span> <span class="k">=</span> <span class="n">image</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">origin</span> <span class="o">+</span> <span class="nc">EuclideanVector</span><span class="o">(</span><span class="mf">10.0</span><span class="o">,</span> <span class="mf">10.0</span><span class="o">,</span> <span class="mf">10.0</span><span class="o">)</span>
<span class="k">val</span> <span class="n">profile</span> <span class="k">=</span> <span class="n">asm</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">head</span>
<span class="k">val</span> <span class="n">feature1</span> <span class="k">:</span> <span class="kt">DenseVector</span><span class="o">[</span><span class="kt">Double</span><span class="o">]</span> <span class="k">=</span> <span class="n">asm</span><span class="o">.</span><span class="n">featureExtractor</span><span class="o">(</span><span class="n">preprocessedImage</span><span class="o">,</span> <span class="n">point1</span><span class="o">,</span> <span class="n">asm</span><span class="o">.</span><span class="n">statisticalModel</span><span class="o">.</span><span class="n">mean</span><span class="o">,</span> <span class="n">profile</span><span class="o">.</span><span class="n">pointId</span><span class="o">).</span><span class="n">get</span>
</code></pre></div></div>

<p>Here we specified the preprocessed image, a point in the image where whe want the evaluate the feature vector, a mesh instance and a point id for the mesh.
The mesh instance and point id are needed, since a feature extractor might choose to extract the feature based on mesh information, such as the normal direction
of a line at this point.</p>

<p>We can retrieve the likelihood that each corresponding point corresponds to a given profile point:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="n">point2</span> <span class="k">=</span> <span class="n">image</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">origin</span> <span class="o">+</span> <span class="nc">EuclideanVector</span><span class="o">(</span><span class="mf">20.0</span><span class="o">,</span> <span class="mf">10.0</span><span class="o">,</span> <span class="mf">10.0</span><span class="o">)</span>
<span class="k">val</span> <span class="n">featureVec1</span> <span class="k">=</span> <span class="n">asm</span><span class="o">.</span><span class="n">featureExtractor</span><span class="o">(</span><span class="n">preprocessedImage</span><span class="o">,</span> <span class="n">point1</span><span class="o">,</span> <span class="n">asm</span><span class="o">.</span><span class="n">statisticalModel</span><span class="o">.</span><span class="n">mean</span><span class="o">,</span> <span class="n">profile</span><span class="o">.</span><span class="n">pointId</span><span class="o">).</span><span class="n">get</span>
<span class="k">val</span> <span class="n">featureVec2</span> <span class="k">=</span> <span class="n">asm</span><span class="o">.</span><span class="n">featureExtractor</span><span class="o">(</span><span class="n">preprocessedImage</span><span class="o">,</span> <span class="n">point2</span><span class="o">,</span> <span class="n">asm</span><span class="o">.</span><span class="n">statisticalModel</span><span class="o">.</span><span class="n">mean</span><span class="o">,</span> <span class="n">profile</span><span class="o">.</span><span class="n">pointId</span><span class="o">).</span><span class="n">get</span>

<span class="k">val</span> <span class="n">probabilityPoint1</span> <span class="k">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">logpdf</span><span class="o">(</span><span class="n">featureVec1</span><span class="o">)</span>
<span class="k">val</span> <span class="n">probabilityPoint2</span> <span class="k">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">logpdf</span><span class="o">(</span><span class="n">featureVec2</span><span class="o">)</span>
</code></pre></div></div>

<p>Based on this information, we can decide, which point is more likely to correspond to the model point. This idea forms the
basis of the original m Active Shape Model Fitting algorithm.</p>

<h3 id="the-original-active-shape-model-fitting">The original Active Shape Model Fitting</h3>

<p>Scalismo features an implementation of Active Shape Model fitting algorithm, as proposed by <a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.141.3089&amp;rep=rep1&amp;type=pdf">Cootes and Taylor</a>.</p>

<p>To configure the fitting process, we need to set up a search method, which searches for a given model point, corresponding  points
in the image. From these points, the most likely point is select and used as as the corresponding point for one iteration of
the algorithm. Once these “candidate correspondences” have been established, the rest of the algorithm works in exactly the same as
the ICP algorithm that we described in the previous tutorials.</p>

<p>One search strategy that is already implemented in Scalismo is to search along
the normal direction of a model point. This behavior is provided by the <code class="highlighter-rouge">NormalDirectionSearchPointSampler</code></p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="n">searchSampler</span> <span class="k">=</span> <span class="nc">NormalDirectionSearchPointSampler</span><span class="o">(</span><span class="n">numberOfPoints</span> <span class="k">=</span> <span class="mi">100</span><span class="o">,</span> <span class="n">searchDistance</span> <span class="k">=</span> <span class="mi">3</span><span class="o">)</span>
</code></pre></div></div>

<p>In addition to the search strategy, we can specify some additional configuration parameters to control the fitting process:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="n">config</span> <span class="k">=</span> <span class="nc">FittingConfiguration</span><span class="o">(</span><span class="n">featureDistanceThreshold</span> <span class="k">=</span> <span class="mi">3</span><span class="o">,</span> <span class="n">pointDistanceThreshold</span> <span class="k">=</span> <span class="mi">5</span><span class="o">,</span> <span class="n">modelCoefficientBounds</span> <span class="k">=</span> <span class="mi">3</span><span class="o">)</span>
</code></pre></div></div>

<p>The first parameter determines how far away (as measured by the mahalanobis distance) an intensity feature can be, such that it is still
chosen as corresponding. The <code class="highlighter-rouge">pointDistanceThreshold</code> does the same for the distance of the points; I.e. in this  case points which are
more than 5 standard deviations aways are not chosen as corresponding points. The last parameters determines how
large coefficients of the model can become in the fitting process. Whenever a model parameter is larger than this threshold,
it will be set back to this maximal value. This introduces a regularization into the fitting, which prevents the shape
from becoming too unlikely.</p>

<p>The ASM fitting algorithm optimizes both the pose (as defined by a rigid transformation) and the shape.
In order to allow it to optimize the rotation, it is important that we choose a rotation center, which is approximately
the center of mass of the model:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// make sure we rotate around a reasonable center point
</span><span class="k">val</span> <span class="n">modelBoundingBox</span> <span class="k">=</span> <span class="n">asm</span><span class="o">.</span><span class="n">statisticalModel</span><span class="o">.</span><span class="n">referenceMesh</span><span class="o">.</span><span class="n">boundingBox</span>
<span class="k">val</span> <span class="n">rotationCenter</span> <span class="k">=</span> <span class="n">modelBoundingBox</span><span class="o">.</span><span class="n">origin</span> <span class="o">+</span> <span class="n">modelBoundingBox</span><span class="o">.</span><span class="n">extent</span> <span class="o">*</span> <span class="mf">0.5</span>    
</code></pre></div></div>

<p>To initialize the fitting process, we also need to set up the initial transformation:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// we start with the identity transform
</span><span class="k">val</span> <span class="n">translationTransformation</span> <span class="k">=</span> <span class="nc">TranslationTransform</span><span class="o">(</span><span class="nc">EuclideanVector</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">))</span>
<span class="k">val</span> <span class="n">rotationTransformation</span> <span class="k">=</span> <span class="nc">RotationTransform</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">rotationCenter</span><span class="o">)</span>
<span class="k">val</span> <span class="n">initialRigidTransformation</span> <span class="k">=</span> <span class="nc">RigidTransformation</span><span class="o">(</span><span class="n">translationTransformation</span><span class="o">,</span> <span class="n">rotationTransformation</span><span class="o">)</span>
<span class="k">val</span> <span class="n">initialModelCoefficients</span> <span class="k">=</span> <span class="nc">DenseVector</span><span class="o">.</span><span class="n">zeros</span><span class="o">[</span><span class="kt">Double</span><span class="o">](</span><span class="n">asm</span><span class="o">.</span><span class="n">statisticalModel</span><span class="o">.</span><span class="n">rank</span><span class="o">)</span>
<span class="k">val</span> <span class="n">initialTransformation</span> <span class="k">=</span> <span class="nc">ModelTransformations</span><span class="o">(</span><span class="n">initialModelCoefficients</span><span class="o">,</span> <span class="n">initialRigidTransformation</span><span class="o">)</span>
</code></pre></div></div>

<p>To start the fitting, we obtain an iterator, which we subsequently use to drive the iteration.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="k">val</span> <span class="n">numberOfIterations</span> <span class="k">=</span> <span class="mi">20</span>
   <span class="k">val</span> <span class="n">asmIterator</span> <span class="k">=</span> <span class="n">asm</span><span class="o">.</span><span class="n">fitIterator</span><span class="o">(</span><span class="n">image</span><span class="o">,</span> <span class="n">searchSampler</span><span class="o">,</span> <span class="n">numberOfIterations</span><span class="o">,</span> <span class="n">config</span><span class="o">,</span> <span class="n">initialTransformation</span><span class="o">)</span>
</code></pre></div></div>

<p>Especially in a debugging phase, we want to visualize the result in every iteration. The following code shows,
how we can obtain a new iterator, which updates the pose transformation and model coefficients in the <code class="highlighter-rouge">ui</code>
in every iteration:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="n">asmIteratorWithVisualization</span> <span class="k">=</span> <span class="n">asmIterator</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">it</span> <span class="k">=&gt;</span> <span class="o">{</span>
  <span class="n">it</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">scala</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="nc">Success</span><span class="o">(</span><span class="n">iterationResult</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="n">modelView</span><span class="o">.</span><span class="n">shapeModelTransformationView</span><span class="o">.</span><span class="n">poseTransformationView</span><span class="o">.</span><span class="n">transformation</span> <span class="k">=</span> <span class="n">iterationResult</span><span class="o">.</span><span class="n">transformations</span><span class="o">.</span><span class="n">rigidTransform</span>
      <span class="n">modelView</span><span class="o">.</span><span class="n">shapeModelTransformationView</span><span class="o">.</span><span class="n">shapeTransformationView</span><span class="o">.</span><span class="n">coefficients</span> <span class="k">=</span> <span class="n">iterationResult</span><span class="o">.</span><span class="n">transformations</span><span class="o">.</span><span class="n">coefficients</span>
    <span class="o">}</span>
    <span class="k">case</span> <span class="n">scala</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="nc">Failure</span><span class="o">(</span><span class="n">error</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="n">error</span><span class="o">.</span><span class="n">getMessage</span><span class="o">)</span>
  <span class="o">}</span>
  <span class="n">it</span>
<span class="o">})</span>   
</code></pre></div></div>

<p>To run the fitting, and get the result, we finally consume the iterator:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="n">asmIteratorWithVisualization</span><span class="o">.</span><span class="n">toIndexedSeq</span><span class="o">.</span><span class="n">last</span>
<span class="k">val</span> <span class="n">finalMesh</span> <span class="k">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">mesh</span>
</code></pre></div></div>

<h2 id="evaluating-the-likelihood-of-a-model-instance-under-the-image">Evaluating the likelihood of a model instance under the image</h2>

<p>In the previous section we have used the intensity distribution to find the best corresponding image point to a
given point in the model. Sometimes we are also interested in finding out how well a model fits an image.
To compute this, we can extend the method used above to compute the likelihood for all profile points of an Active Shape Model.</p>

<p>Given the model instance, we will get the position of each profile point in the current instance,
evaluate its likelihood and then compute the joint likelihood for all profiles. Assuming independence, the joint probability is just the product of the probability at the individual profile points.
In order not to get too extreme values, we use log probabilities here (and consequently the product becomes a sum).</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">likelihoodForMesh</span><span class="o">(</span><span class="n">asm</span> <span class="k">:</span> <span class="kt">ActiveShapeModel</span><span class="o">,</span> <span class="n">mesh</span> <span class="k">:</span> <span class="kt">TriangleMesh</span><span class="o">[</span><span class="k">_</span><span class="err">3</span><span class="kt">D</span><span class="o">],</span> <span class="n">preprocessedImage</span><span class="k">:</span> <span class="kt">PreprocessedImage</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="o">{</span>

    <span class="k">val</span> <span class="n">ids</span> <span class="k">=</span> <span class="n">asm</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">ids</span>

    <span class="k">val</span> <span class="n">likelihoods</span> <span class="k">=</span> <span class="k">for</span> <span class="o">(</span><span class="n">id</span> <span class="k">&lt;-</span> <span class="n">ids</span><span class="o">)</span> <span class="k">yield</span> <span class="o">{</span>
        <span class="k">val</span> <span class="n">profile</span> <span class="k">=</span> <span class="n">asm</span><span class="o">.</span><span class="n">profiles</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
        <span class="k">val</span> <span class="n">profilePointOnMesh</span> <span class="k">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">pointSet</span><span class="o">.</span><span class="n">point</span><span class="o">(</span><span class="n">profile</span><span class="o">.</span><span class="n">pointId</span><span class="o">)</span>
        <span class="k">val</span> <span class="n">featureAtPoint</span> <span class="k">=</span> <span class="n">asm</span><span class="o">.</span><span class="n">featureExtractor</span><span class="o">(</span><span class="n">preprocessedImage</span><span class="o">,</span> <span class="n">profilePointOnMesh</span><span class="o">,</span> <span class="n">mesh</span><span class="o">,</span> <span class="n">profile</span><span class="o">.</span><span class="n">pointId</span><span class="o">).</span><span class="n">get</span>
        <span class="n">profile</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">logpdf</span><span class="o">(</span><span class="n">featureAtPoint</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="n">likelihoods</span><span class="o">.</span><span class="n">sum</span>
<span class="o">}</span>
</code></pre></div></div>

<p>This method allows us to compute for each mesh, represented by the model, how likely it is to correspond
to the given image.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="n">sampleMesh1</span> <span class="k">=</span> <span class="n">asm</span><span class="o">.</span><span class="n">statisticalModel</span><span class="o">.</span><span class="n">sample</span> 
<span class="k">val</span> <span class="n">sampleMesh2</span> <span class="k">=</span> <span class="n">asm</span><span class="o">.</span><span class="n">statisticalModel</span><span class="o">.</span><span class="n">sample</span>
<span class="n">println</span><span class="o">(</span><span class="s">"Likelihood for mesh 1 = "</span> <span class="o">+</span> <span class="n">likelihoodForMesh</span><span class="o">(</span><span class="n">asm</span><span class="o">,</span> <span class="n">sampleMesh1</span><span class="o">,</span> <span class="n">preprocessedImage</span><span class="o">))</span>
<span class="n">println</span><span class="o">(</span><span class="s">"Likelihood for mesh 2 = "</span> <span class="o">+</span> <span class="n">likelihoodForMesh</span><span class="o">(</span><span class="n">asm</span><span class="o">,</span> <span class="n">sampleMesh2</span><span class="o">,</span> <span class="n">preprocessedImage</span><span class="o">))</span>
</code></pre></div></div>

<p>This information is all that is need to write probabilistic fitting methods methods using Markov Chain Monte Carlo
methods, which will be discussed in a later tutorial.</p>

</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/scalismo.github.io/highlight/highlight.pack.js"></script><script>hljs.configure({languages:['scala','java','bash']});
hljs.initHighlighting();
              </script><script>((window.gitter = {}).chat = {}).options = {
room: 'marcelluethi/scalismo.github.io'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/scalismo.github.io/js/main.js"></script></body></html>